---
- name: Deploy KELP
  hosts: kelp
  become: yes

  tasks:
    - name: Wait for cloud-init
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        timeout: 300

    - name: Install Docker dependencies
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: Start Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create app directory
      file:
        path: /opt/kelp
        state: directory

    - name: Copy project files
      synchronize:
        src: "{{ playbook_dir }}/../../"
        dest: /opt/kelp/
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=deploy"
          - "--exclude=.venv"
          - "--exclude=__pycache__"
          - "--exclude=.ruff_cache"

    - name: Copy Dockerfile
      copy:
        src: "{{ playbook_dir }}/../Dockerfile"
        dest: /opt/kelp/Dockerfile

    - name: Build Docker image
      community.docker.docker_image:
        name: kelp
        tag: latest
        source: build
        build:
          path: /opt/kelp
        force_source: yes

    - name: Run KELP container
      community.docker.docker_container:
        name: kelp
        image: kelp:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "127.0.0.1:8000:8000"

    - name: Install Caddy GPG key
      apt_key:
        url: https://dl.cloudsmith.io/public/caddy/stable/gpg.key
        state: present

    - name: Add Caddy repository
      apt_repository:
        repo: deb https://dl.cloudsmith.io/public/caddy/stable/deb/debian any-version main
        state: present

    - name: Install Caddy
      apt:
        name: caddy
        state: present
        update_cache: yes

    - name: Configure Caddy
      copy:
        content: |
          kelp.vroblok.io {
              reverse_proxy localhost:8000
          }
        dest: /etc/caddy/Caddyfile
      notify: Restart Caddy

    - name: Start Caddy service
      systemd:
        name: caddy
        state: started
        enabled: yes

  handlers:
    - name: Restart Caddy
      systemd:
        name: caddy
        state: restarted
        daemon_reload: yes
