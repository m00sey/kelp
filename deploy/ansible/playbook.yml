---
- name: Deploy KELP
  hosts: kelp
  become: yes

  tasks:
    - name: Wait for cloud-init
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        timeout: 300

    - name: Install Docker dependencies
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repository
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        state: present

    - name: Install Docker
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: Start Docker service
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create app directory
      file:
        path: /opt/kelp
        state: directory

    - name: Copy project files
      synchronize:
        src: "{{ playbook_dir }}/../../"
        dest: /opt/kelp/
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=deploy"
          - "--exclude=.venv"
          - "--exclude=__pycache__"
          - "--exclude=.ruff_cache"

    - name: Copy Dockerfile
      copy:
        src: "{{ playbook_dir }}/../Dockerfile"
        dest: /opt/kelp/Dockerfile

    - name: Build Docker image
      community.docker.docker_image:
        name: kelp
        tag: latest
        source: build
        build:
          path: /opt/kelp
        force_source: yes

    - name: Run KELP container
      community.docker.docker_container:
        name: kelp
        image: kelp:latest
        state: started
        restart_policy: unless-stopped
        ports:
          - "127.0.0.1:8000:8000"

    - name: Download Caddy
      get_url:
        url: https://caddyserver.com/api/download?os=linux&arch=amd64
        dest: /usr/local/bin/caddy
        mode: '0755'

    - name: Create caddy user
      user:
        name: caddy
        system: yes
        shell: /usr/sbin/nologin
        create_home: no

    - name: Create Caddy directories
      file:
        path: "{{ item }}"
        state: directory
        owner: caddy
        group: caddy
      loop:
        - /etc/caddy
        - /var/lib/caddy

    - name: Configure Caddy
      copy:
        content: |
          kelp.vroblok.io {
              reverse_proxy localhost:8000
          }
        dest: /etc/caddy/Caddyfile
      notify: Restart Caddy

    - name: Create Caddy systemd service
      copy:
        content: |
          [Unit]
          Description=Caddy
          After=network.target

          [Service]
          User=caddy
          Group=caddy
          Environment=XDG_DATA_HOME=/var/lib/caddy
          Environment=XDG_CONFIG_HOME=/var/lib/caddy
          ExecStart=/usr/local/bin/caddy run --config /etc/caddy/Caddyfile
          ExecReload=/usr/local/bin/caddy reload --config /etc/caddy/Caddyfile
          Restart=on-failure
          AmbientCapabilities=CAP_NET_BIND_SERVICE

          [Install]
          WantedBy=multi-user.target
        dest: /etc/systemd/system/caddy.service
      notify: Restart Caddy

    - name: Start Caddy service
      systemd:
        name: caddy
        state: started
        enabled: yes
        daemon_reload: yes

  handlers:
    - name: Restart Caddy
      systemd:
        name: caddy
        state: restarted
        daemon_reload: yes
